<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>California Water Systems Network Dashboard</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
        }
        .container-fluid {
            height: 100vh;
            padding: 0;
        }
        .row {
            margin: 0;
            height: 100%;
        }
        #map {
            height: 600px;
            width: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            z-index: 1;
            position: relative;
        }
        .sidebar {
            height: 100%;
            overflow-y: auto;
            background: linear-gradient(to bottom, #e6f2ff, #c9e5ff);
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        .main-content {
            padding: 20px;
            height: 100%;
            overflow-y: auto;
        }
        .card {
            margin-bottom: 20px;
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        .card-header {
            background: linear-gradient(to right, #007bff, #0056b3);
            color: white;
            border-radius: 10px 10px 0 0 !important;
            font-weight: 600;
        }
        .btn-primary {
            background: linear-gradient(to right, #007bff, #0056b3);
            border: none;
        }
        .btn-secondary {
            background: linear-gradient(to right, #6c757d, #5a6268);
            border: none;
        }
        .nav-tabs .nav-link.active {
            font-weight: bold;
            border-bottom: 3px solid #007bff;
        }
        h2 {
            color: #0056b3;
            font-weight: 700;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        .form-range::-webkit-slider-thumb {
            background: #007bff;
        }
        .form-range::-moz-range-thumb {
            background: #007bff;
        }
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-size: 24px;
            color: #007bff;
        }
        .legend {
            padding: 10px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            position: absolute;
            bottom: 10px;
            right: 10px;
            z-index: 1000;
        }
        .legend i {
            display: inline-block;
            width: 18px;
            height: 18px;
            margin-right: 5px;
            border-radius: 50%;
        }
        .legend-triangle {
            display: inline-block;
            width: 0;
            height: 0;
            border-left: 9px solid transparent;
            border-right: 9px solid transparent;
            border-bottom: 18px solid red;
            margin-right: 5px;
        }
        .instructions {
            background-color: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .instructions h4 {
            margin-top: 0;
            color: #007bff;
        }
        /* Arrow legend styling */
        .legend-arrow {
            display: inline-block;
            width: 20px;
            height: 3px;
            background: #0066CC;
            position: relative;
            margin-right: 5px;
            border-radius: 0;
        }
        .legend-arrow::after {
            content: '';
            position: absolute;
            right: -5px;
            top: -3px;
            width: 0;
            height: 0;
            border-top: 5px solid transparent;
            border-bottom: 5px solid transparent;
            border-left: 5px solid #0066CC;
        }
        .download-btn {
            margin-top: 10px;
            width: 100%;
        }
        .search-container {
            position: relative;
        }
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ccc;
            border-top: none;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        .search-result-item {
            padding: 8px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        .search-result-item:hover {
            background-color: #f0f0f0;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-3 sidebar">
                <div class="p-3">
                    <h2 class="text-center mb-4">California Water Systems</h2>
                    
                    <!-- Search functionality -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h5>Search & Zoom</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-2 search-container">
                                <label for="searchSystem" class="form-label">Search System:</label>
                                <input type="text" id="searchSystem" class="form-control" placeholder="Type system name...">
                                <div id="systemResults" class="search-results"></div>
                            </div>
                            <div class="mb-2 search-container">
                                <label for="searchPWSID" class="form-label">Search PWSID:</label>
                                <input type="text" id="searchPWSID" class="form-control" placeholder="Type PWSID...">
                                <div id="pwsidResults" class="search-results"></div>
                            </div>
                            <div class="mb-2 search-container">
                                <label for="searchSource" class="form-label">Search Source:</label>
                                <input type="text" id="searchSource" class="form-control" placeholder="Type source name...">
                                <div id="sourceResults" class="search-results"></div>
                            </div>
                            <div class="d-grid gap-2">
                                <button id="zoomSelected" class="btn btn-primary">Zoom to Selected</button>
                                <button id="resetView" class="btn btn-secondary">Reset View and Filters</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- System Filters -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h5>System Filters</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-2">
                                <label for="gwSupply" class="form-label">GW Supply:</label>
                                <select id="gwSupply" class="form-select">
                                    <option value="All">All</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                            </div>
                            <div class="mb-2">
                                <label for="popBin" class="form-label">System Size:</label>
                                <select id="popBin" class="form-select">
                                    <option value="All">All</option>
                                    <option value="Small">Small</option>
                                    <option value="Large">Large</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Source Filters -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h5>Source Filters</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-2">
                                <label for="sourceType" class="form-label">Source Type:</label>
                                <select id="sourceType" class="form-select">
                                    <option value="All">All</option>
                                </select>
                            </div>
                            <div class="mb-2">
                                <label for="project" class="form-label">Project:</label>
                                <select id="project" class="form-select">
                                    <option value="All">All</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Connection Filters -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h5>Connection Filters</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-2">
                                <label for="purchaseType" class="form-label">Purchase Type:</label>
                                <select id="purchaseType" class="form-select">
                                    <option value="All">All</option>
                                    <option value="Yes">Purchased</option>
                                    <option value="No">Direct</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Download buttons -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h5>Download Data</h5>
                        </div>
                        <div class="card-body">
                            <button id="downloadSystems" class="btn btn-primary download-btn">Download Systems CSV</button>
                            <button id="downloadSources" class="btn btn-primary download-btn">Download Sources CSV</button>
                            <button id="downloadConnections" class="btn btn-primary download-btn">Download Connections CSV</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Main content -->
            <div class="col-md-9 col-lg-9 main-content">
                <div id="loading" class="loading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <span class="ms-3">Loading water system data...</span>
                </div>
                
                <div id="content" style="display: none;">
                    <div id="map">
                        <div class="legend">
                            <strong>Map Legend:</strong>
                            <div><span class="legend-triangle"></span> Water Source</div>
                            <div><i style="background: blue;"></i> Water System</div>
                            <div><span class="legend-arrow"></span> Connection</div>
                        </div>
                    </div>
                    
                    <ul class="nav nav-tabs mt-4" id="myTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="systems-tab" data-bs-toggle="tab" data-bs-target="#systems" type="button" role="tab">Systems</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="connections-tab" data-bs-toggle="tab" data-bs-target="#connections" type="button" role="tab">Connections</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="sources-tab" data-bs-toggle="tab" data-bs-target="#sources" type="button" role="tab">Sources</button>
                        </li>
                    </ul>
                    
                    <div class="tab-content" id="myTabContent">
                        <div class="tab-pane fade show active" id="systems" role="tabpanel">
                            <table id="systemsTable" class="table table-striped" style="width:100%"></table>
                        </div>
                        <div class="tab-pane fade" id="connections" role="tabpanel">
                            <table id="connectionsTable" class="table table-striped" style="width:100%"></table>
                        </div>
                        <div class="tab-pane fade" id="sources" role="tabpanel">
                            <table id="sourcesTable" class="table table-striped" style="width:100%"></table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    
    <!-- Leaflet Polyline Decorator for arrowheads -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.min.js"></script>
    
    <!-- Custom JavaScript -->
    <script>
        // Global variables
        let map;
        let systemsData = [];
        let sourcesData = [];
        let connectionsData = [];
        let systemsTable, connectionsTable, sourcesTable;
        let currentMarkers = [];
        let currentLines = [];
        let currentDecorators = [];
        let selectedSystem = null;
        let selectedPWSID = null;
        let selectedSource = null;

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        async function initializeApp() {
            // Load data
            try {
                await loadCSVData();
            } catch (error) {
                console.error("Error loading CSV data:", error);
                alert("Failed to load CSV data. Using sample data instead. Check console for details.");
                await loadSampleData();
            }
            
            // Initialize map
            initMap();
            
            // Initialize filters
            initFilters();
            
            // Initialize data tables
            initDataTables();
            
            // Render initial data
            renderData();
            
            // Hide loading and show content
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';
        }

        // Load CSV data
        async function loadCSVData() {
            // Load systems data
            systemsData = await loadCSV('20250908_fake_systems.csv');
            
            // Load sources data
            sourcesData = await loadCSV('20250908_fake_sources.csv');
            
            // Load connections data
            connectionsData = await loadCSV('20250908_fake_links.csv');
            
            // Process data (convert string numbers to actual numbers)
            processData();
        }

        function loadCSV(url) {
            return new Promise((resolve, reject) => {
                Papa.parse(url, {
                    download: true,
                    header: true,
                    dynamicTyping: true,
                    complete: function(results) {
                        resolve(results.data);
                    },
                    error: function(error) {
                        reject(error);
                    }
                });
            });
        }

        function processData() {
            // Convert numeric fields if needed
            systemsData.forEach(system => {
                system.population = Number(system.population) || 0;
                system.lon = Number(system.lon) || 0;
                system.lat = Number(system.lat) || 0;
            });
            
            sourcesData.forEach(source => {
                source.source_lon = Number(source.source_lon) || 0;
                source.source_lat = Number(source.source_lat) || 0;
            });
            
            connectionsData.forEach(connection => {
                connection.volume_mgd = Number(connection.volume_mgd) || 0;
                connection.pct_of_supply = Number(connection.pct_of_supply) || 0;
            });
        }

        // Load sample data (if CSV loading fails)
        async function loadSampleData() {
            // Sample data - replace with your actual data loading from CSV files
            systemsData = [
                {system_name: "San Francisco PWS", pwsid: "CA1234567", county: "San Francisco", population: 147351, pop_bin: "Large", provider_type: "Retail", is_wholesale: "N", has_gw_supply: "Yes", gw_mcl_compliant: "NA", lat: 36.1118330078898, lon: -118.593996792566, num_sw_sources: 3},
                {system_name: "Los Angeles PWS", pwsid: "CA2345678", county: "Los Angeles", population: 395211, pop_bin: "Large", provider_type: "Retail", is_wholesale: "Y", has_gw_supply: "Yes", gw_mcl_compliant: "Yes", lat: 35.5091100451536, lon: -122.49656374671, num_sw_sources: 2},
                {system_name: "San Diego PWS", pwsid: "CA3456789", county: "San Diego", population: 207444, pop_bin: "Large", provider_type: "Retail", is_wholesale: "N", has_gw_supply: "Yes", gw_mcl_compliant: "Yes", lat: 38.4805202138377, lon: -119.885758842458, num_sw_sources: 3},
                {system_name: "Sacramento PWS", pwsid: "CA4567890", county: "Sacramento", population: 442094, pop_bin: "Small", provider_type: "Retail", is_wholesale: "N", has_gw_supply: "Yes", gw_mcl_compliant: "Yes", lat: 36.4668398776557, lon: -121.289346131613, num_sw_sources: 2},
                {system_name: "Fresno PWS", pwsid: "CA5678901", county: "Fresno", population: 470531, pop_bin: "Large", provider_type: "Both", is_wholesale: "Y", has_gw_supply: "Yes", gw_mcl_compliant: "Yes", lat: 38.4553539417684, lon: -120.411009042524, num_sw_sources: 3},
                {system_name: "Oakland PWS", pwsid: "CA6789012", county: "Alameda", population: 27550, pop_bin: "Small", provider_type: "Wholesale", is_wholesale: "N", has_gw_supply: "Yes", gw_mcl_compliant: "NA", lat: 38.4681423023576, lon: -119.129759481992, num_sw_sources: 1},
                {system_name: "San Jose PWS", pwsid: "CA7890123", county: "Santa Clara", population: 266412, pop_bin: "Large", provider_type: "Both", is_wholesale: "N", has_gw_supply: "Yes", gw_mcl_compliant: "No", lat: 38.3688827661099, lon: -120.565111499163, num_sw_sources: 1},
                {system_name: "Long Beach PWS", pwsid: "CA8901234", county: "Los Angeles", population: 446747, pop_bin: "Small", provider_type: "Wholesale", is_wholesale: "N", has_gw_supply: "No", gw_mcl_compliant: "Yes", lat: 36.4190742818173, lon: -121.888755166088, num_sw_sources: 1},
                {system_name: "Bakersfield PWS", pwsid: "CA9012345", county: "Kern", population: 277960, pop_bin: "Small", provider_type: "Retail", is_wholesale: "N", has_gw_supply: "Yes", gw_mcl_compliant: "NA", lat: 38.1496133725159, lon: -121.160092900041, num_sw_sources: 3},
                {system_name: "Santa Cruz PWS", pwsid: "CA0123456", county: "Santa Cruz", population: 231024, pop_bin: "Small", provider_type: "Wholesale", is_wholesale: "N", has_gw_supply: "Yes", gw_mcl_compliant: "Yes", lat: 37.460716223577, lon: -118.825694269035, num_sw_sources: 2}
            ];
            
            sourcesData = [
                {source_id: "src_A", source_name: "Hetch Hetchy Reservoir", source_type: "Reservoir", source_lat: 37.9468, source_lon: -119.7866, project: "SWP", num_systems_served: 1},
                {source_id: "src_B", source_name: "Owens River", source_type: "River", source_lat: 36.5436, source_lon: -118.2732, project: "LADWP", num_systems_served: 1},
                {source_id: "src_C", source_name: "Colorado River Aqueduct", source_type: "Aqueduct", source_lat: 33.7175, source_lon: -114.7222, project: "MWD", num_systems_served: 3},
                {source_id: "src_D", source_name: "Sacramento River", source_type: "River", source_lat: 38.5976, source_lon: -121.1927, project: "CVP", num_systems_served: 4},
                {source_id: "src_E", source_name: "Feather River", source_type: "River", source_lat: 39.6543, source_lon: -121.3456, project: "CVP", num_systems_served: 4},
                {source_id: "src_F", source_name: "Local Groundwater", source_type: "Groundwater", source_lat: 37.2345, source_lon: -121.1234, project: "Local", num_systems_served: 6},
                {source_id: "src_G", source_name: "Delta Intake", source_type: "River Intake", source_lat: 38.0456, source_lon: -121.789, project: "SWP", num_systems_served: 2}
            ];
            
            connectionsData = [
                {source_id: "src_A", pwsid: "CA1234567", purchased: "No", volume_mgd: 99, pct_of_supply: 19, most_recent_year: 2017},
                {source_id: "src_B", pwsid: "CA1234567", purchased: "Yes", volume_mgd: 107, pct_of_supply: 19, most_recent_year: 2016},
                {source_id: "src_D", pwsid: "CA1234567", purchased: "No", volume_mgd: 124, pct_of_supply: 49, most_recent_year: 2021},
                {source_id: "src_F", pwsid: "CA2345678", purchased: "Yes", volume_mgd: 37, pct_of_supply: 96, most_recent_year: 2020},
                {source_id: "src_D", pwsid: "CA2345678", purchased: "Yes", volume_mgd: 114, pct_of_supply: null, most_recent_year: null},
                {source_id: "src_E", pwsid: "CA3456789", purchased: "Yes", volume_mgd: 135, pct_of_supply: 68, most_recent_year: 2024},
                {source_id: "src_E", pwsid: "CA3456789", purchased: "Yes", volume_mgd: 166, pct_of_supply: 68, most_recent_year: 2016},
                {source_id: "src_C", pwsid: "CA3456789", purchased: "No", volume_mgd: 159, pct_of_supply: 68, most_recent_year: 2016},
                {source_id: "src_F", pwsid: "CA4567890", purchased: "No", volume_mgd: 171, pct_of_supply: 50, most_recent_year: 2023},
                {source_id: "src_C", pwsid: "CA4567890", purchased: "Yes", volume_mgd: 105, pct_of_supply: null, most_recent_year: null},
                {source_id: "src_F", pwsid: "CA5678901", purchased: "No", volume_mgd: 88, pct_of_supply: 20, most_recent_year: 2017},
                {source_id: "src_F", pwsid: "CA5678901", purchased: "Yes", volume_mgd: 60, pct_of_supply: 20, most_recent_year: 2020},
                {source_id: "src_G", pwsid: "CA5678901", purchased: "No", volume_mgd: 130, pct_of_supply: null, most_recent_year: null},
                {source_id: "src_D", pwsid: "CA6789012", purchased: "Yes", volume_mgd: 121, pct_of_supply: null, most_recent_year: null},
                {source_id: "src_G", pwsid: "CA7890123", purchased: "No", volume_mgd: 60, pct_of_supply: null, most_recent_year: null},
                {source_id: "src_E", pwsid: "CA8901234", purchased: "Yes", volume_mgd: 128, pct_of_supply: 92, most_recent_year: 2017},
                {source_id: "src_F", pwsid: "CA9012345", purchased: "No", volume_mgd: 138, pct_of_supply: 24, most_recent_year: 2020},
                {source_id: "src_C", pwsid: "CA9012345", purchased: "No", volume_mgd: 19, pct_of_supply: 47, most_recent_year: 2020},
                {source_id: "src_D", pwsid: "CA9012345", purchased: "No", volume_mgd: 143, pct_of_supply: 47, most_recent_year: 2019},
                {source_id: "src_F", pwsid: "CA0123456", purchased: "No", volume_mgd: 184, pct_of_supply: 84, most_recent_year: 2022},
                {source_id: "src_E", pwsid: "CA0123456", purchased: "Yes", volume_mgd: 127, pct_of_supply: 84, most_recent_year: 2021}
            ];
        }

        function initMap() {
            // Initialize map with proper options
            map = L.map('map', {
                center: [37.2, -119.4],
                zoom: 6,
                zoomControl: true,
                attributionControl: true
            });
            
            // Add base layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            // Fix map display issues
            setTimeout(() => {
                map.invalidateSize();
            }, 100);
        }

        function initFilters() {
            // Add event listeners to all filter controls
            document.getElementById('gwSupply').addEventListener('change', renderData);
            document.getElementById('popBin').addEventListener('change', renderData);
            document.getElementById('sourceType').addEventListener('change', renderData);
            document.getElementById('project').addEventListener('change', renderData);
            document.getElementById('purchaseType').addEventListener('change', renderData);
            
            // Search and zoom functionality
            document.getElementById('zoomSelected').addEventListener('click', zoomToSelected);
            document.getElementById('resetView').addEventListener('click', resetView);
            
            // Setup search functionality
            setupSearch();
            
            // Setup download buttons
            document.getElementById('downloadSystems').addEventListener('click', () => downloadCSV(systemsData, 'systems.csv'));
            document.getElementById('downloadSources').addEventListener('click', () => downloadCSV(sourcesData, 'sources.csv'));
            document.getElementById('downloadConnections').addEventListener('click', () => downloadCSV(connectionsData, 'connections.csv'));
            
            // Populate filter dropdowns
            populateFilters();
        }
        
        function setupSearch() {
            // System search
            const systemSearch = document.getElementById('searchSystem');
            const systemResults = document.getElementById('systemResults');
            
            systemSearch.addEventListener('input', function() {
                const query = this.value.toLowerCase();
                if (query.length < 2) {
                    systemResults.style.display = 'none';
                    return;
                }
                
                const results = systemsData.filter(system => 
                    system.system_name.toLowerCase().includes(query)
                );
                
                displaySearchResults(systemResults, results, 'system_name', (item) => {
                    selectedSystem = item;
                    systemSearch.value = item.system_name;
                    systemResults.style.display = 'none';
                });
            });
            
            // PWSID search
            const pwsidSearch = document.getElementById('searchPWSID');
            const pwsidResults = document.getElementById('pwsidResults');
            
            pwsidSearch.addEventListener('input', function() {
                const query = this.value.toLowerCase();
                if (query.length < 2) {
                    pwsidResults.style.display = 'none';
                    return;
                }
                
                const results = systemsData.filter(system => 
                    system.pwsid.toLowerCase().includes(query)
                );
                
                displaySearchResults(pwsidResults, results, 'pwsid', (item) => {
                    selectedPWSID = item;
                    pwsidSearch.value = item.pwsid;
                    pwsidResults.style.display = 'none';
                });
            });
            
            // Source search
            const sourceSearch = document.getElementById('searchSource');
            const sourceResults = document.getElementById('sourceResults');
            
            sourceSearch.addEventListener('input', function() {
                const query = this.value.toLowerCase();
                if (query.length < 2) {
                    sourceResults.style.display = 'none';
                    return;
                }
                
                const results = sourcesData.filter(source => 
                    source.source_name.toLowerCase().includes(query)
                );
                
                displaySearchResults(sourceResults, results, 'source_name', (item) => {
                    selectedSource = item;
                    sourceSearch.value = item.source_name;
                    sourceResults.style.display = 'none';
                });
            });
            
            // Hide search results when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.search-container')) {
                    document.querySelectorAll('.search-results').forEach(el => {
                        el.style.display = 'none';
                    });
                }
            });
        }
        
        function displaySearchResults(container, results, displayField, onClick) {
            container.innerHTML = '';
            
            if (results.length === 0) {
                container.innerHTML = '<div class="search-result-item">No results found</div>';
            } else {
                results.slice(0, 10).forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'search-result-item';
                    div.textContent = item[displayField];
                    div.addEventListener('click', () => onClick(item));
                    container.appendChild(div);
                });
            }
            
            container.style.display = 'block';
        }
        
        function populateFilters() {
            // Populate source types
            const sourceTypes = [...new Set(sourcesData.map(s => s.source_type))].filter(Boolean);
            const sourceTypeSelect = document.getElementById('sourceType');
            sourceTypeSelect.innerHTML = '<option value="All">All</option>';
            sourceTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                sourceTypeSelect.appendChild(option);
            });
            
            // Populate projects
            const projects = [...new Set(sourcesData.map(s => s.project))].filter(Boolean);
            const projectSelect = document.getElementById('project');
            projectSelect.innerHTML = '<option value="All">All</option>';
            projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project;
                option.textContent = project;
                projectSelect.appendChild(option);
            });
        }

        function initDataTables() {
            // Initialize DataTables
            systemsTable = $('#systemsTable').DataTable({
                data: [],
                columns: [
                    { title: "System Name", data: "system_name" },
                    { title: "PWSID", data: "pwsid" },
                    { title: "County", data: "county" },
                    { title: "Population", data: "population", render: $.fn.dataTable.render.number(',', '.', 0) },
                    { title: "Size", data: "pop_bin" },
                    { title: "Provider Type", data: "provider_type" },
                    { title: "Wholesale", data: "is_wholesale" },
                    { title: "GW Supply", data: "has_gw_supply" },
                    { title: "GW MCL Compliant", data: "gw_mcl_compliant" },
                    { title: "SW Sources", data: "num_sw_sources" }
                ],
                pageLength: 5
            });
            
            connectionsTable = $('#connectionsTable').DataTable({
                data: [],
                columns: [
                    { title: "Source ID", data: "source_id" },
                    { title: "PWSID", data: "pwsid" },
                    { title: "Purchased", data: "purchased" },
                    { title: "Volume (MGD)", data: "volume_mgd" },
                    { title: "% of Supply", data: "pct_of_supply" },
                    { title: "Most Recent Year", data: "most_recent_year" }
                ],
                pageLength: 5
            });
            
            sourcesTable = $('#sourcesTable').DataTable({
                data: [],
                columns: [
                    { title: "Source ID", data: "source_id" },
                    { title: "Source Name", data: "source_name" },
                    { title: "Source Type", data: "source_type" },
                    { title: "Project", data: "project" },
                    { title: "Systems Served", data: "num_systems_served" }
                ],
                pageLength: 5
            });
        }

        function filterData() {
          // Get filter values
          const gwSupply = document.getElementById('gwSupply').value;
          const popBin = document.getElementById('popBin').value;
          const sourceType = document.getElementById('sourceType').value;
          const project = document.getElementById('project').value;
          const purchaseType = document.getElementById('purchaseType').value;
          
          // Start with all data
          let filteredSystems = [...systemsData];
          let filteredSources = [...sourcesData];
          let filteredConnections = [...connectionsData];
          
          // Apply system filters first
          if (gwSupply !== 'All') {
            filteredSystems = filteredSystems.filter(system => system.has_gw_supply === gwSupply);
          }
          if (popBin !== 'All') {
            filteredSystems = filteredSystems.filter(system => system.pop_bin === popBin);
          }
          
          // Apply source filters
          if (sourceType !== 'All') {
            filteredSources = filteredSources.filter(source => source.source_type === sourceType);
          }
          if (project !== 'All') {
            filteredSources = filteredSources.filter(source => source.project === project);
          }
          
          // Apply connection filters
          if (purchaseType !== 'All') {
            filteredConnections = filteredConnections.filter(connection => connection.purchased === purchaseType);
          }
          
          // Now make sure all three datasets are consistent with each other
          
          // Filter connections to only include connections between filtered systems and filtered sources
          filteredConnections = filteredConnections.filter(connection => {
            const hasSystem = filteredSystems.some(system => system.pwsid === connection.pwsid);
            const hasSource = filteredSources.some(source => source.source_id === connection.source_id);
            return hasSystem && hasSource;
          });
          
          // Filter systems to only include those with connections to filtered sources
          const connectedSystemPWSIDs = [...new Set(filteredConnections.map(conn => conn.pwsid))];
          filteredSystems = filteredSystems.filter(system => 
            connectedSystemPWSIDs.includes(system.pwsid)
          );
          
          // Filter sources to only include those with connections to filtered systems
          const connectedSourceIDs = [...new Set(filteredConnections.map(conn => conn.source_id))];
          filteredSources = filteredSources.filter(source => 
            connectedSourceIDs.includes(source.source_id)
          );
  
  return { filteredSystems, filteredSources, filteredConnections };
}

        function renderData() {
            // Clear existing markers and lines
            clearMap();
            
            // Get filtered data
            const { filteredSystems, filteredSources, filteredConnections } = filterData();
            
            // Update data tables
            systemsTable.clear().rows.add(filteredSystems).draw();
            sourcesTable.clear().rows.add(filteredSources).draw();
            connectionsTable.clear().rows.add(filteredConnections).draw();
            
            // Add markers for systems
            filteredSystems.forEach(system => {
              // Use a fixed size instead of population-based sizing
              const marker = L.circleMarker([system.lat, system.lon], {
                  radius: 8,  // Fixed size
                  fillColor: 'blue',
                  color: 'darkblue',
                  weight: 1,
                  opacity: 1,
                  fillOpacity: 0.8
              }).addTo(map);
                
               marker.bindPopup(`
                  <strong>${system.system_name}</strong><br>
                  PWSID: ${system.pwsid}<br>
                  Population: ${system.population.toLocaleString()}<br>
                  County: ${system.county}<br>
                  Provider Type: ${system.provider_type || 'N/A'}<br>
                  SW Sources: ${system.num_sw_sources || 'N/A'}<br>
                  GW Access: ${system.has_gw_supply || 'N/A'}<br>
                  DWL-Compliant GW: ${system.gw_mcl_compliant || 'N/A'}
              `);
                
                currentMarkers.push(marker);
            });
            
            // Add markers for sources (as red triangles)
            filteredSources.forEach(source => {
                // Create a custom triangle icon
                const triangleIcon = L.divIcon({
                    className: 'triangle-icon',
                    html: '<div style="width: 0; height: 0; border-left: 8px solid transparent; border-right: 8px solid transparent; border-bottom: 16px solid red;"></div>',
                    iconSize: [16, 16],
                    iconAnchor: [8, 8]
                });
                
                const marker = L.marker([source.source_lat, source.source_lon], {icon: triangleIcon}).addTo(map);
                
                marker.bindPopup(`
                    <strong>${source.source_name}</strong><br>
                    Type: ${source.source_type}<br>
                    Project: ${source.project}<br>
                    Systems Served: ${source.num_systems_served}
                `);
                
                currentMarkers.push(marker);
            });
            
            // Add lines for connections
            filteredConnections.forEach(connection => {
                const source = filteredSources.find(s => s.source_id === connection.source_id);
                const system = filteredSystems.find(s => s.pwsid === connection.pwsid);
                
                if (source && system) {
                    const latlngs = [
                        [source.source_lat, source.source_lon],
                        [system.lat, system.lon]
                    ];
                    
                    const line = L.polyline(latlngs, {
                        color: '#0066CC',
                        weight: 2,
                        opacity: 0.7
                    }).addTo(map);
                    
                    // Add arrow to show direction
                    const decorator = L.polylineDecorator(line, {
                        patterns: [
                            {
                                offset: '90%',
                                repeat: 0,
                                symbol: L.Symbol.arrowHead({
                                    pixelSize: 10,
                                    polygon: false,
                                    pathOptions: {
                                        stroke: true,
                                        color: '#0066CC',
                                        weight: 2,
                                        opacity: 0.7
                                    }
                                })
                            }
                        ]
                    }).addTo(map);
                    
                    currentLines.push(line);
                    currentDecorators.push(decorator);
                    
                    line.bindPopup(`
                        <strong>Connection</strong><br>
                        Source: ${source.source_name}<br>
                        System: ${system.system_name}<br>
                        Purchased: ${connection.purchased}
                    `);
                }
            });
        }

        function clearMap() {
            // Remove all current markers and lines
            currentMarkers.forEach(marker => map.removeLayer(marker));
            currentLines.forEach(line => map.removeLayer(line));
            currentDecorators.forEach(decorator => map.removeLayer(decorator));
            
            // Clear arrays
            currentMarkers = [];
            currentLines = [];
            currentDecorators = [];
        }

        function zoomToSelected() {
            let bounds = L.latLngBounds();
            let hasSelection = false;
            
            if (selectedSystem) {
                bounds.extend([selectedSystem.lat, selectedSystem.lon]);
                hasSelection = true;
            }
            
            if (selectedPWSID) {
                const system = systemsData.find(s => s.pwsid === selectedPWSID.pwsid);
                if (system) {
                    bounds.extend([system.lat, system.lon]);
                    hasSelection = true;
                }
            }
            
            if (selectedSource) {
                bounds.extend([selectedSource.source_lat, selectedSource.source_lon]);
                hasSelection = true;
            }
            
            if (hasSelection) {
                map.fitBounds(bounds, { padding: [50, 50] });
            } else {
                alert("Please select a system, PWSID, or source to zoom to.");
            }
        }

        function resetView() {
          // Reset map view
          map.setView([37.2, -119.4], 6);
          
          // Reset all filters
          document.getElementById('gwSupply').value = 'All';
          document.getElementById('popBin').value = 'All';
          document.getElementById('sourceType').value = 'All';
          document.getElementById('project').value = 'All';
          document.getElementById('purchaseType').value = 'All';
          
          // Reset search fields
          document.getElementById('searchSystem').value = '';
          document.getElementById('searchPWSID').value = '';
          document.getElementById('searchSource').value = '';
          
          // Clear selection variables
          selectedSystem = null;
          selectedPWSID = null;
          selectedSource = null;
          
          // Hide any visible search results
          document.querySelectorAll('.search-results').forEach(el => {
              el.style.display = 'none';
          });
          
          // Re-render the data with all filters reset
          renderData();
      }

        function downloadCSV(data, filename) {
            const csv = Papa.unparse(data);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>