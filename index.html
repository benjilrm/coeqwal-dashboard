<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>California Water Systems Dashboard</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        body {
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        #map {
            height: 600px;
            margin-bottom: 20px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .filter-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .filter-group {
            margin-bottom: 15px;
        }
        .legend {
            padding: 10px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }
        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.7;
        }
        .data-table {
            margin-top: 20px;
        }
        .section-title {
            border-bottom: 2px solid #0d6efd;
            padding-bottom: 5px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <h1 class="text-center mb-4">California Water Systems Dashboard</h1>
        
        <!-- Search and Filters Section -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Search and Filters</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Search Box -->
                            <div class="col-md-4 mb-3">
                                <label for="search-input" class="form-label">Search (System Name, PWSID, Source Name)</label>
                                <input type="text" class="form-control" id="search-input" placeholder="Enter search term...">
                            </div>
                            <div class="col-md-2 mb-3 d-flex align-items-end">
                                <button id="search-btn" class="btn btn-primary">Search</button>
                            </div>
                            <div class="col-md-6 mb-3 d-flex align-items-end justify-content-end">
                                <button id="download-btn" class="btn btn-success">Download Filtered Data</button>
                                <button id="reset-btn" class="btn btn-outline-secondary ms-2">Reset Filters</button>
                            </div>
                        </div>
                        
                        <div class="row">
                            <!-- Sources Filters -->
                            <div class="col-md-4">
                                <h6 class="section-title">Sources Filters</h6>
                                <div class="filter-group">
                                    <label for="project-filter" class="form-label">Project</label>
                                    <select class="form-select" id="project-filter" multiple>
                                        <option value="SWP">SWP</option>
                                        <option value="LADWP">LADWP</option>
                                        <option value="MWD">MWD</option>
                                        <option value="CVP">CVP</option>
                                        <option value="Local">Local</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label for="source-type-filter" class="form-label">Source Type</label>
                                    <select class="form-select" id="source-type-filter" multiple>
                                        <option value="Reservoir">Reservoir</option>
                                        <option value="River">River</option>
                                        <option value="Aqueduct">Aqueduct</option>
                                        <option value="Groundwater">Groundwater</option>
                                        <option value="River Intake">River Intake</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label class="form-label">Number of Systems Served</label>
                                    <div class="row">
                                        <div class="col">
                                            <input type="number" class="form-control" id="min-systems" placeholder="Min" min="1">
                                        </div>
                                        <div class="col">
                                            <input type="number" class="form-control" id="max-systems" placeholder="Max">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Systems Filters -->
                            <div class="col-md-4">
                                <h6 class="section-title">Systems Filters</h6>
                                <div class="filter-group">
                                    <label for="system-size-filter" class="form-label">System Size</label>
                                    <select class="form-select" id="system-size-filter" multiple>
                                        <option value="Small">Small</option>
                                        <option value="Large">Large</option>
                                    </select>
                                </div>
                                <div class="filter-group">
                                    <label for="gw-access-filter" class="form-label">GW Access</label>
                                    <select class="form-select" id="gw-access-filter">
                                        <option value="all">All</option>
                                        <option value="Yes">Yes</option>
                                        <option value="No">No</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Links Filters -->
                            <div class="col-md-4">
                                <h6 class="section-title">Links Filters</h6>
                                <div class="filter-group">
                                    <label class="form-label">% of Supply</label>
                                    <div class="row">
                                        <div class="col">
                                            <input type="number" class="form-control" id="min-pct-supply" placeholder="Min" min="0" max="100">
                                        </div>
                                        <div class="col">
                                            <input type="number" class="form-control" id="max-pct-supply" placeholder="Max" min="0" max="100">
                                        </div>
                                    </div>
                                </div>
                                <div class="filter-group">
                                    <label for="purchased-filter" class="form-label">Purchased</label>
                                    <select class="form-select" id="purchased-filter">
                                        <option value="all">All</option>
                                        <option value="Yes">Yes</option>
                                        <option value="No">No</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Map Section -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div id="map"></div>
            </div>
        </div>
        
        <!-- Data Table Section -->
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Filtered Data</h5>
                    </div>
                    <div class="card-body">
                        <ul class="nav nav-tabs" id="dataTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="sources-tab" data-bs-toggle="tab" data-bs-target="#sources" type="button" role="tab">Sources</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="systems-tab" data-bs-toggle="tab" data-bs-target="#systems" type="button" role="tab">Systems</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="links-tab" data-bs-toggle="tab" data-bs-target="#links" type="button" role="tab">Links</button>
                            </li>
                        </ul>
                        <div class="tab-content p-3" id="dataTabsContent">
                            <div class="tab-pane fade show active" id="sources" role="tabpanel">
                                <table class="table table-striped table-hover" id="sources-table">
                                    <thead>
                                        <tr>
                                            <th>Source ID</th>
                                            <th>Source Name</th>
                                            <th>Source Type</th>
                                            <th>Project</th>
                                            <th>Systems Served</th>
                                            <th>Latitude</th>
                                            <th>Longitude</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                            <div class="tab-pane fade" id="systems" role="tabpanel">
                                <table class="table table-striped table-hover" id="systems-table">
                                    <thead>
                                        <tr>
                                            <th>System Name</th>
                                            <th>PWSID</th>
                                            <th>County</th>
                                            <th>Population</th>
                                            <th>Size</th>
                                            <th>Provider Type</th>
                                            <th>GW Access</th>
                                            <th>GW Compliant</th>
                                            <th>SW Sources</th>
                                            <th>Latitude</th>
                                            <th>Longitude</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                            <div class="tab-pane fade" id="links" role="tabpanel">
                                <table class="table table-striped table-hover" id="links-table">
                                    <thead>
                                        <tr>
                                            <th>Source ID</th>
                                            <th>PWSID</th>
                                            <th>Purchased</th>
                                            <th>Volume (MGD)</th>
                                            <th>% of Supply</th>
                                            <th>Year</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- PapaParse for CSV processing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    
    <!-- FileSaver for download functionality -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <script>
        // Global variables to store data
        let sourcesData = [];
        let systemsData = [];
        let linksData = [];
        
        // Global variables for map elements
        let map;
        let sourcesLayer;
        let systemsLayer;
        let linksLayer = [];
        
        // Initialize the application when the DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Parse the CSV data (embedded in the HTML)
            parseCSVData();
            
            // Initialize the map
            initMap();
            
            // Set up event listeners
            setupEventListeners();
            
            // Apply initial rendering
            applyFilters();
        });
        
        // Parse the CSV data embedded in the HTML
        function parseCSVData() {
            // Parse sources data
            const sourcesCSV = `"source_id","source_name","source_type","source_lat","source_lon","project","num_systems_served"
"src_A","Hetch Hetchy Reservoir","Reservoir",37.9468,-119.7866,"SWP",1
"src_B","Owens River","River",36.5436,-118.2732,"LADWP",1
"src_C","Colorado River Aqueduct","Aqueduct",33.7175,-114.7222,"MWD",3
"src_D","Sacramento River","River",38.5976,-121.1927,"CVP",4
"src_E","Feather River","River",39.6543,-121.3456,"CVP",4
"src_F","Local Groundwater","Groundwater",37.2345,-121.1234,"Local",6
"src_G","Delta Intake","River Intake",38.0456,-121.789,"SWP",2`;
            
            // Parse systems data
            const systemsCSV = `"system_name","pwsid","county","population","pop_bin","provider_type","is_wholesale","has_gw_supply","gw_mcl_compliant","lat","lon","num_sw_sources"
"San Francisco PWS","CA1234567","San Francisco",147351,"Large","Retail","N","Yes","NA",36.1118330078898,-118.593996792566,3
"Los Angeles PWS","CA2345678","Los Angeles",395211,"Large","Retail","Y","Yes","Yes",35.5091100451536,-122.49656374671,2
"San Diego PWS","CA3456789","San Diego",207444,"Large","Retail","N","Yes","Yes",38.4805202138377,-119.885758842458,3
"Sacramento PWS","CA4567890","Sacramento",442094,"Small","Retail","N","Yes","Yes",36.4668398776557,-121.289346131613,2
"Fresno PWS","CA5678901","Fresno",470531,"Large","Both","Y","Yes","Yes",38.4553539417684,-120.411009042524,3
"Oakland PWS","CA6789012","Alameda",27550,"Small","Wholesale","N","Yes","NA",38.4681423023576,-119.129759481992,1
"San Jose PWS","CA7890123","Santa Clara",266412,"Large","Both","N","Yes","No",38.3688827661099,-120.565111499163,1
"Long Beach PWS","CA8901234","Los Angeles",446747,"Small","Wholesale","N","No","Yes",36.4190742818173,-121.888755166088,1
"Bakersfield PWS","CA9012345","Kern",277960,"Small","Retail","N","Yes","NA",38.1496133725159,-121.160092900041,3
"Santa Cruz PWS","CA0123456","Santa Cruz",231024,"Small","Wholesale","N","Yes","Yes",37.460716223577,-118.825694269035,2`;
            
            // Parse links data
            const linksCSV = `"source_id","pwsid","purchased","volume_mgd","pct_of_supply","most_recent_year"
"src_A","CA1234567","No",99,19,2017
"src_B","CA1234567","Yes",107,19,2016
"src_D","CA1234567","No",124,49,2021
"src_F","CA2345678","Yes",37,96,2020
"src_D","CA2345678","Yes",114,NA,NA
"src_E","CA3456789","Yes",135,68,2024
"src_E","CA3456789","Yes",166,68,2016
"src_C","CA3456789","No",159,68,2016
"src_F","CA4567890","No",171,50,2023
"src_C","CA4567890","Yes",105,NA,NA
"src_F","CA5678901","No",88,20,2017
"src_F","CA5678901","Yes",60,20,2020
"src_G","CA5678901","No",130,NA,NA
"src_D","CA6789012","Yes",121,NA,NA
"src_G","CA7890123","No",60,NA,NA
"src_E","CA8901234","Yes",128,92,2017
"src_F","CA9012345","No",138,24,2020
"src_C","CA9012345","No",19,47,2020
"src_D","CA9012345","No",143,47,2019
"src_F","CA0123456","No",184,84,2022
"src_E","CA0123456","Yes",127,84,2021`;
            
            // Parse the CSV strings into JavaScript objects
            sourcesData = Papa.parse(sourcesCSV, {header: true}).data;
            systemsData = Papa.parse(systemsCSV, {header: true}).data;
            linksData = Papa.parse(linksCSV, {header: true}).data;
            
            // Convert numeric fields to numbers
            sourcesData.forEach(source => {
                source.source_lat = parseFloat(source.source_lat);
                source.source_lon = parseFloat(source.source_lon);
                source.num_systems_served = parseInt(source.num_systems_served);
            });
            
            systemsData.forEach(system => {
                system.lat = parseFloat(system.lat);
                system.lon = parseFloat(system.lon);
                system.population = parseInt(system.population);
                system.num_sw_sources = parseInt(system.num_sw_sources);
            });
            
            linksData.forEach(link => {
                link.volume_mgd = parseFloat(link.volume_mgd);
                link.pct_of_supply = link.pct_of_supply === "NA" ? null : parseFloat(link.pct_of_supply);
                link.most_recent_year = link.most_recent_year === "NA" ? null : parseInt(link.most_recent_year);
            });
        }
        
        // Initialize the map
        function initMap() {
            // Create map centered on California
            map = L.map('map').setView([36.7783, -119.4179], 6);
            
            // Add base tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            // Create layer groups
            sourcesLayer = L.layerGroup().addTo(map);
            systemsLayer = L.layerGroup().addTo(map);
            
            // Add legend
            const legend = L.control({position: 'bottomright'});
            legend.onAdd = function() {
                const div = L.DomUtil.create('div', 'legend');
                div.innerHTML = `
                    <h4>Legend</h4>
                    <p><i style="background: blue; border-radius: 50%;"></i> Water Source</p>
                    <p><i style="background: green; border-radius: 50%;"></i> Water System</p>
                    <p><i style="background: gray; width: 10px; height: 2px; margin-top: 8px;"></i> Water Link</p>
                `;
                return div;
            };
            legend.addTo(map);
        }
        
        // Set up event listeners for filters and buttons
        function setupEventListeners() {
            // Add change listeners to all filters
            document.getElementById('project-filter').addEventListener('change', applyFilters);
            document.getElementById('source-type-filter').addEventListener('change', applyFilters);
            document.getElementById('min-systems').addEventListener('input', applyFilters);
            document.getElementById('max-systems').addEventListener('input', applyFilters);
            document.getElementById('system-size-filter').addEventListener('change', applyFilters);
            document.getElementById('gw-access-filter').addEventListener('change', applyFilters);
            document.getElementById('min-pct-supply').addEventListener('input', applyFilters);
            document.getElementById('max-pct-supply').addEventListener('input', applyFilters);
            document.getElementById('purchased-filter').addEventListener('change', applyFilters);
            
            // Search button
            document.getElementById('search-btn').addEventListener('click', handleSearch);
            
            // Download button
            document.getElementById('download-btn').addEventListener('click', downloadData);
            
            // Reset button
            document.getElementById('reset-btn').addEventListener('click', resetFilters);
        }
        
        // Apply all filters and update the map and table
        function applyFilters() {
            // Get filter values
            const projectFilter = getSelectedValues('project-filter');
            const sourceTypeFilter = getSelectedValues('source-type-filter');
            const minSystems = document.getElementById('min-systems').value ? parseInt(document.getElementById('min-systems').value) : null;
            const maxSystems = document.getElementById('max-systems').value ? parseInt(document.getElementById('max-systems').value) : null;
            const systemSizeFilter = getSelectedValues('system-size-filter');
            const gwAccessFilter = document.getElementById('gw-access-filter').value;
            const minPctSupply = document.getElementById('min-pct-supply').value ? parseFloat(document.getElementById('min-pct-supply').value) : null;
            const maxPctSupply = document.getElementById('max-pct-supply').value ? parseFloat(document.getElementById('max-pct-supply').value) : null;
            const purchasedFilter = document.getElementById('purchased-filter').value;
            
            // Filter sources
            const filteredSources = sourcesData.filter(source => {
                // Project filter
                if (projectFilter.length > 0 && !projectFilter.includes(source.project)) return false;
                
                // Source type filter
                if (sourceTypeFilter.length > 0 && !sourceTypeFilter.includes(source.source_type)) return false;
                
                // Number of systems served filter
                if (minSystems !== null && source.num_systems_served < minSystems) return false;
                if (maxSystems !== null && source.num_systems_served > maxSystems) return false;
                
                return true;
            });
            
            // Filter systems
            const filteredSystems = systemsData.filter(system => {
                // System size filter
                if (systemSizeFilter.length > 0 && !systemSizeFilter.includes(system.pop_bin)) return false;
                
                // GW access filter
                if (gwAccessFilter !== 'all' && system.has_gw_supply !== gwAccessFilter) return false;
                
                return true;
            });
            
            // Filter links
            const filteredLinks = linksData.filter(link => {
                // % of supply filter
                if (minPctSupply !== null && (link.pct_of_supply === null || link.pct_of_supply < minPctSupply)) return false;
                if (maxPctSupply !== null && (link.pct_of_supply === null || link.pct_of_supply > maxPctSupply)) return false;
                
                // Purchased filter
                if (purchasedFilter !== 'all' && link.purchased !== purchasedFilter) return false;
                
                // Check if source and system are in filtered lists
                const sourceInFiltered = filteredSources.some(source => source.source_id === link.source_id);
                const systemInFiltered = filteredSystems.some(system => system.pwsid === link.pwsid);
                
                return sourceInFiltered && systemInFiltered;
            });
            
            // Update map with filtered data
            updateMap(filteredSources, filteredSystems, filteredLinks);
            
            // Update tables with filtered data
            updateTables(filteredSources, filteredSystems, filteredLinks);
        }
        
        // Get selected values from a multi-select element
        function getSelectedValues(selectId) {
            const select = document.getElementById(selectId);
            return Array.from(select.selectedOptions).map(option => option.value);
        }
        
        // Update the map with filtered data
        function updateMap(sources, systems, links) {
            // Clear existing layers
            sourcesLayer.clearLayers();
            systemsLayer.clearLayers();
            linksLayer.forEach(layer => map.removeLayer(layer));
            linksLayer = [];
            
            // Add filtered sources to map
            sources.forEach(source => {
                const marker = L.circleMarker([source.source_lat, source.source_lon], {
                    color: 'blue',
                    fillColor: 'blue',
                    fillOpacity: 0.7,
                    radius: 8
                });
                
                // Add popup
                marker.bindPopup(`
                    <strong>Source Name:</strong> ${source.source_name}<br>
                    <strong>Project:</strong> ${source.project}<br>
                    <strong>Source Type:</strong> ${source.source_type}<br>
                    <strong>Number of Systems Served:</strong> ${source.num_systems_served}
                `);
                
                marker.addTo(sourcesLayer);
            });
            
            // Add filtered systems to map
            systems.forEach(system => {
                const marker = L.circleMarker([system.lat, system.lon], {
                    color: 'green',
                    fillColor: 'green',
                    fillOpacity: 0.7,
                    radius: 8
                });
                
                // Add popup
                marker.bindPopup(`
                    <strong>System Name:</strong> ${system.system_name}<br>
                    <strong>PWSID:</strong> ${system.pwsid}<br>
                    <strong>County:</strong> ${system.county}<br>
                    <strong>Provider Type:</strong> ${system.provider_type}<br>
                    <strong>Population Served:</strong> ${system.population.toLocaleString()}<br>
                    <strong>Total SW Sources:</strong> ${system.num_sw_sources}<br>
                    <strong>Has GW Access:</strong> ${system.has_gw_supply}<br>
                    <strong>DWS-Compliant GW:</strong> ${system.gw_mcl_compliant}
                `);
                
                marker.addTo(systemsLayer);
            });
            
            // Add filtered links to map
            links.forEach(link => {
                // Find source and system coordinates
                const source = sources.find(s => s.source_id === link.source_id);
                const system = systems.find(s => s.pwsid === link.pwsid);
                
                if (source && system) {
                    // Create a polyline with arrowhead
                    const polyline = L.polyline([
                        [source.source_lat, source.source_lon],
                        [system.lat, system.lon]
                    ], {
                        color: 'gray',
                        weight: 2
                    });
                    
                    // Add arrowhead
                    const arrowHead = L.polylineDecorator(polyline, {
                        patterns: [
                            {
                                offset: '100%',
                                repeat: 0,
                                symbol: L.Symbol.arrowHead({
                                    pixelSize: 10,
                                    polygon: false,
                                    pathOptions: {
                                        stroke: true,
                                        color: 'gray',
                                        weight: 2
                                    }
                                })
                            }
                        ]
                    });
                    
                    // Add popup
                    polyline.bindPopup(`
                        <strong>Purchased:</strong> ${link.purchased}<br>
                        <strong>Source ID:</strong> ${link.source_id}<br>
                        <strong>PWSID:</strong> ${link.pwsid}<br>
                        <strong>Volume (MGD):</strong> ${link.volume_mgd}<br>
                        <strong>% of Supply:</strong> ${link.pct_of_supply || 'N/A'}<br>
                        <strong>Year:</strong> ${link.most_recent_year || 'N/A'}
                    `);
                    
                    polyline.addTo(map);
                    arrowHead.addTo(map);
                    linksLayer.push(polyline);
                    linksLayer.push(arrowHead);
                }
            });
            
            // Fit map to show all visible elements
            const allLayers = L.featureGroup([sourcesLayer, systemsLayer, ...linksLayer]);
            if (allLayers.getLayers().length > 0) {
                map.fitBounds(allLayers.getBounds(), {padding: [50, 50]});
            }
        }
        
        // Update the data tables with filtered data
        function updateTables(sources, systems, links) {
            // Update sources table
            const sourcesTable = document.getElementById('sources-table').querySelector('tbody');
            sourcesTable.innerHTML = '';
            
            sources.forEach(source => {
                const row = sourcesTable.insertRow();
                row.insertCell(0).textContent = source.source_id;
                row.insertCell(1).textContent = source.source_name;
                row.insertCell(2).textContent = source.source_type;
                row.insertCell(3).textContent = source.project;
                row.insertCell(4).textContent = source.num_systems_served;
                row.insertCell(5).textContent = source.source_lat.toFixed(4);
                row.insertCell(6).textContent = source.source_lon.toFixed(4);
            });
            
            // Update systems table
            const systemsTable = document.getElementById('systems-table').querySelector('tbody');
            systemsTable.innerHTML = '';
            
            systems.forEach(system => {
                const row = systemsTable.insertRow();
                row.insertCell(0).textContent = system.system_name;
                row.insertCell(1).textContent = system.pwsid;
                row.insertCell(2).textContent = system.county;
                row.insertCell(3).textContent = system.population.toLocaleString();
                row.insertCell(4).textContent = system.pop_bin;
                row.insertCell(5).textContent = system.provider_type;
                row.insertCell(6).textContent = system.has_gw_supply;
                row.insertCell(7).textContent = system.gw_mcl_compliant;
                row.insertCell(8).textContent = system.num_sw_sources;
                row.insertCell(9).textContent = system.lat.toFixed(4);
                row.insertCell(10).textContent = system.lon.toFixed(4);
            });
            
            // Update links table
            const linksTable = document.getElementById('links-table').querySelector('tbody');
            linksTable.innerHTML = '';
            
            links.forEach(link => {
                const row = linksTable.insertRow();
                row.insertCell(0).textContent = link.source_id;
                row.insertCell(1).textContent = link.pwsid;
                row.insertCell(2).textContent = link.purchased;
                row.insertCell(3).textContent = link.volume_mgd;
                row.insertCell(4).textContent = link.pct_of_supply || 'N/A';
                row.insertCell(5).textContent = link.most_recent_year || 'N/A';
            });
        }
        
        // Handle search functionality
        function handleSearch() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            
            if (!searchTerm) return;
            
            // Find matching source or system
            const matchingSource = sourcesData.find(source => 
                source.source_id.toLowerCase().includes(searchTerm) || 
                source.source_name.toLowerCase().includes(searchTerm)
            );
            
            const matchingSystem = systemsData.find(system => 
                system.system_name.toLowerCase().includes(searchTerm) || 
                system.pwsid.toLowerCase().includes(searchTerm)
            );
            
            if (matchingSource) {
                // Zoom to source
                map.setView([matchingSource.source_lat, matchingSource.source_lon], 10);
            } else if (matchingSystem) {
                // Zoom to system
                map.setView([matchingSystem.lat, matchingSystem.lon], 10);
            } else {
                alert('No matching source or system found.');
            }
        }
        
        // Download filtered data as CSV
        function downloadData() {
            // Get filtered data (simplified for this example)
            // In a real implementation, you would use the actual filtered data
            const sourcesCSV = Papa.unparse(sourcesData);
            const systemsCSV = Papa.unparse(systemsData);
            const linksCSV = Papa.unparse(linksData);
            
            // Create blobs
            const sourcesBlob = new Blob([sourcesCSV], {type: 'text/csv;charset=utf-8;'});
            const systemsBlob = new Blob([systemsCSV], {type: 'text/csv;charset=utf-8;'});
            const linksBlob = new Blob([linksCSV], {type: 'text/csv;charset=utf-8;'});
            
            // Download files
            saveAs(sourcesBlob, 'water_sources.csv');
            saveAs(systemsBlob, 'water_systems.csv');
            saveAs(linksBlob, 'water_links.csv');
        }
        
        // Reset all filters
        function resetFilters() {
            document.getElementById('project-filter').selectedIndex = -1;
            document.getElementById('source-type-filter').selectedIndex = -1;
            document.getElementById('min-systems').value = '';
            document.getElementById('max-systems').value = '';
            document.getElementById('system-size-filter').selectedIndex = -1;
            document.getElementById('gw-access-filter').value = 'all';
            document.getElementById('min-pct-supply').value = '';
            document.getElementById('max-pct-supply').value = '';
            document.getElementById('purchased-filter').value = 'all';
            document.getElementById('search-input').value = '';
            
            applyFilters();
        }
        
        // Polyline Decorator for arrowheads (simplified implementation)
        L.PolylineDecorator = L.Polyline.extend({
            initialize: function(polyline, options) {
                this._polyline = polyline;
                L.Util.setOptions(this, options);
            },
            
            onAdd: function(map) {
                this._map = map;
                this._draw();
            },
            
            _draw: function() {
                const patterns = this.options.patterns;
                if (!patterns || !patterns.length) return;
                
                patterns.forEach(pattern => {
                    if (pattern.symbol && pattern.symbol.arrowHead) {
                        // Simplified arrowhead drawing
                        const latlngs = this._polyline.getLatLngs();
                        if (latlngs.length < 2) return;
                        
                        const lastPoint = latlngs[latlngs.length - 1];
                        const prevPoint = latlngs[latlngs.length - 2];
                        
                        // Calculate angle
                        const dx = lastPoint.lng - prevPoint.lng;
                        const dy = lastPoint.lat - prevPoint.lat;
                        const angle = Math.atan2(dy, dx);
                        
                        // Create arrowhead marker
                        const arrow = L.marker(lastPoint, {
                            icon: L.divIcon({
                                className: 'arrowhead-icon',
                                html: '<div style="transform: rotate(' + angle + 'rad);">âž¤</div>',
                                iconSize: [10, 10]
                            })
                        });
                        
                        arrow.addTo(this._map);
                        this._arrowheads = this._arrowheads || [];
                        this._arrowheads.push(arrow);
                    }
                });
            },
            
            onRemove: function() {
                if (this._arrowheads) {
                    this._arrowheads.forEach(arrow => this._map.removeLayer(arrow));
                }
            }
        });
        
        L.polylineDecorator = function(polyline, options) {
            return new L.PolylineDecorator(polyline, options);
        };
        
        L.Symbol = {
            arrowHead: function(options) {
                return {
                    arrowHead: true,
                    options: options
                };
            }
        };
    </script>
</body>
</html>